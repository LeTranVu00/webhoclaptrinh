{% extends 'courses/base.html' %}

{% block content %}
<!-- Th√™m Breadcrumb -->
<div class="breadcrumb-optimized" id="breadcrumb">
    <div class="container">
        <div class="cart-breadcrumb">
            <a href="/" class="crumb">
                <span>üè†</span>
                <span>Trang ch·ªß</span>
            </a>
            <div class="crumb-separator">‚Ä∫</div>
            <a href="{% url 'forum_list' %}" class="crumb">
                <span>üí¨</span>
                <span>Di·ªÖn ƒë√†n</span>
            </a>
            <div class="crumb-separator">‚Ä∫</div>
            {% if post.category %}
            <a href="{% url 'forum_category' post.category %}" class="crumb">
                <span>üè∑Ô∏è</span>
                <span>{{ post.get_category_display }}</span>
            </a>
            <div class="crumb-separator">‚Ä∫</div>
            {% endif %}
            <div class="crumb current">
                <span>üìñ</span>
                <span>{{ post.title|truncatechars:40 }}</span>
            </div>
        </div>
    </div>
</div>

<div class="forum-detail-page">
    <!-- Navigation -->
    <div class="detail-navigation">
        <div class="container">
            <div class="nav-content">
                <a href="{% url 'forum_list' %}" class="nav-back">
                    <span class="nav-icon">‚Üê</span>
                    <span class="nav-text">Quay l·∫°i di·ªÖn ƒë√†n</span>
                </a>
                
                <div class="nav-actions">
                    {% if user == post.author or user.is_staff %}
                    <div class="dropdown">
                        <button class="dropdown-toggle">
                            <span>‚öôÔ∏è</span>
                            <span>Tu·ª≥ ch·ªçn</span>
                        </button>
                        <div class="dropdown-menu">
                            {% if user.is_staff %}
                            <form method="post" action="{% url 'forum_toggle_pin' post.id %}" class="dropdown-form">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item">
                                    {% if post.is_pinned %}üìå B·ªè ghim{% else %}üìå Ghim b√†i{% endif %}
                                </button>
                            </form>
                            {% if post.is_featured %}
                            <form method="post" action="{% url 'forum_toggle_feature' post.id %}" class="dropdown-form">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item">
                                    ‚≠ê B·ªè n·ªïi b·∫≠t
                                </button>
                            </form>
                            {% else %}
                            <form method="post" action="{% url 'forum_toggle_feature' post.id %}" class="dropdown-form">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item">
                                    ‚≠ê ƒê√°nh d·∫•u n·ªïi b·∫≠t
                                </button>
                            </form>
                            {% endif %}
                            {% endif %}
                            <a href="{% url 'forum_edit' post.id %}" class="dropdown-item">‚úèÔ∏è Ch·ªânh s·ª≠a b√†i vi·∫øt</a>
                            {% if user.is_staff %}
                            <button class="dropdown-item delete-post">üóëÔ∏è Xo√° b√†i vi·∫øt</button>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    <button class="nav-action" onclick="scrollToComments()">
                        <span>üí¨</span>
                        <span>B√¨nh lu·∫≠n</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="detail-wrapper">
            <!-- Left: Main Post -->
            <div class="detail-main">
                <!-- Post Badges -->
                <div class="post-badges">
                    {% if post.is_pinned %}
                    <span class="badge pinned">üìå B√†i vi·∫øt ƒë∆∞·ª£c ghim</span>
                    {% endif %}
                    {% if post.is_featured %}
                    <span class="badge featured">‚≠ê B√†i vi·∫øt n·ªïi b·∫≠t</span>
                    {% endif %}
                    {% if post.is_solved %}
                    <span class="badge solved">‚úÖ ƒê√£ gi·∫£i ƒë√°p</span>
                    {% endif %}
                    <span class="badge category">{{ post.get_category_display }}</span>
                </div>

                <!-- Main Post -->
                <article class="main-post">
                    <header class="post-header">
                        <div class="author-section">
                            <div class="author-avatar">
                                {{ post.author.username|slice:":1"|upper }}
                            </div>
                            <div class="author-info">
                                <div class="author-main">
                                    <strong class="author-name">{{ post.author.username }}</strong>
                                    {% if post.author.is_staff %}
                                    <span class="author-badge staff">üëë Admin</span>
                                    {% endif %}
                                    {% if post.author.is_expert %}
                                    <span class="author-badge expert">üß† Chuy√™n gia</span>
                                    {% endif %}
                                </div>
                                <div class="post-meta">
                                    <span class="post-time">{{ post.created_at|date:"H:i ‚Ä¢ d/m/Y" }}</span>
                                    {% if post.updated_at != post.created_at %}
                                    <span class="post-edited">(ƒë√£ ch·ªânh s·ª≠a {{ post.updated_at|timesince }} tr∆∞·ªõc)</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="post-stats">
                            <div class="stat-item">
                                <span class="stat-icon">üëÅÔ∏è</span>
                                <span class="stat-value">{{ post.views|default:"1.2k" }}</span>
                                <span class="stat-label">l∆∞·ª£t xem</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">üí¨</span>
                                <span class="stat-value">{{ post_total_comments }}</span>
                                <span class="stat-label">b√¨nh lu·∫≠n</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">‚è±Ô∏è</span>
                                <span class="stat-value">{{ reading_time }} ph√∫t</span>
                            </div>
                        </div>
                    </header>

                    <h1 class="post-title">{{ post.title }}</h1>

                    <div class="post-content" id="postContent">
                        {{ post.content|linebreaksbr|urlize }}
                    </div>

                    {% if post.tags %}
                    <div class="post-tags">
                        {% for tag in post.tags.split %}
                        <a href="{% url 'forum_tag' tag %}" class="post-tag">#{{ tag }}</a>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <footer class="post-footer">
                        <div class="reaction-section">
                            <form method="post" action="{% url 'toggle_like' post.id %}" class="reaction-form like-form">
                                {% csrf_token %}
                                <button type="button" class="reaction-btn like-btn {% if user_has_liked %}active{% endif %}">
                                    <span class="reaction-icon">‚ù§Ô∏è</span>
                                    <span class="reaction-count">{{ like_count }}</span>
                                    <span class="reaction-label">Th√≠ch</span>
                                </button>
                            </form>
                            
                            <button class="reaction-btn" onclick="toggleReactions()">
                                <span class="reaction-icon">üëç</span>
                                <span class="reaction-count">42</span>
                            </button>
                            
                            <div class="reactions-panel" id="reactionsPanel">
                                <button class="reaction-option" data-reaction="like">üëç</button>
                                <button class="reaction-option" data-reaction="love">‚ù§Ô∏è</button>
                                <button class="reaction-option" data-reaction="laugh">üòÑ</button>
                                <button class="reaction-option" data-reaction="wow">üò≤</button>
                                <button class="reaction-option" data-reaction="sad">üò¢</button>
                                <button class="reaction-option" data-reaction="angry">üò†</button>
                            </div>
                        </div>

                        <div class="action-section">
                            <button class="action-btn" onclick="sharePost()">
                                <span class="action-icon">üì§</span>
                                <span class="action-text">Chia s·∫ª</span>
                            </button>
                            
                            <button class="action-btn bookmark-btn {% if user_has_saved %}active{% endif %}" 
                                    onclick="toggleBookmark()">
                                <span class="action-icon">üîñ</span>
                                <span class="action-text">L∆∞u</span>
                            </button>
                            
                            <button class="action-btn" onclick="scrollToComments()">
                                <span class="action-icon">üí¨</span>
                                <span class="action-text">B√¨nh lu·∫≠n</span>
                            </button>
                            
                            <button class="action-btn report-btn" onclick="reportPost()">
                                <span class="action-icon">üö®</span>
                                <span class="action-text">B√°o c√°o</span>
                            </button>
                        </div>
                    </footer>

                    <!-- Post Navigation -->
                    <div class="post-navigation">
                        {% if previous_post %}
                        <a href="{% url 'forum_detail' previous_post.id %}" class="nav-post prev">
                            <span class="nav-direction">‚Üê B√†i tr∆∞·ªõc</span>
                            <span class="nav-title">{{ previous_post.title|truncatechars:50 }}</span>
                        </a>
                        {% endif %}
                        
                        {% if next_post %}
                        <a href="{% url 'forum_detail' next_post.id %}" class="nav-post next">
                            <span class="nav-direction">B√†i sau ‚Üí</span>
                            <span class="nav-title">{{ next_post.title|truncatechars:50 }}</span>
                        </a>
                        {% endif %}
                    </div>
                </article>

                <!-- Comments Section -->
                <section class="comments-section" id="commentsSection">
                    <div class="section-header">
                        <h2>
                            <span class="section-icon">üí¨</span>
                            <span class="section-title">B√¨nh lu·∫≠n</span>
                            <span class="comment-count">({{ comments|length }})</span>
                        </h2>
                        <div class="section-actions">
                            <button class="sort-btn" onclick="toggleSort()">
                                <span>S·∫Øp x·∫øp: </span>
                                <span id="sortText">M·ªõi nh·∫•t</span>
                                <span>‚ñº</span>
                            </button>
                        </div>
                    </div>

                    <!-- Comment Form -->
                    {% if user.is_authenticated %}
                    <form method="post" action="{% url 'add_comment' post.id %}" class="comment-form" id="commentForm">
                        {% csrf_token %}
                        <div class="comment-editor">
                            <div class="editor-header">
                                <div class="editor-tools">
                                    <button type="button" class="tool-btn" data-tag="bold"><b>B</b></button>
                                    <button type="button" class="tool-btn" data-tag="italic"><i>I</i></button>
                                    <button type="button" class="tool-btn" data-tag="code">{"{}"}</button>
                                    <button type="button" class="tool-btn" data-tag="link">üîó</button>
                                </div>
                            </div>
                            <textarea name="content" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." 
                                      required rows="3" class="comment-input"></textarea>
                            <div class="editor-footer">
                                <small>Nh·∫•n Ctrl+Enter ƒë·ªÉ g·ª≠i nhanh</small>
                                <button type="submit" class="btn-submit">
                                    <span>üì§</span>
                                    <span>G·ª≠i b√¨nh lu·∫≠n</span>
                                </button>
                            </div>
                        </div>
                    </form>
                    {% else %}
                    <div class="auth-prompt">
                        <div class="prompt-icon">üîí</div>
                        <div class="prompt-content">
                            <h3>ƒêƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n</h3>
                            <p>Tham gia th·∫£o lu·∫≠n c√πng c·ªông ƒë·ªìng l·∫≠p tr√¨nh vi√™n</p>
                            <div class="prompt-actions">
                                <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn-login">üîì ƒêƒÉng nh·∫≠p</a>
                                <a href="{% url 'account_signup' %}" class="btn-signup">üìù ƒêƒÉng k√Ω</a>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Comments List -->
                    <div class="comments-list" id="commentsList">
                        {% for comment in comments %}
                        <div class="comment-card {% if comment.author == post.author %}author-comment{% endif %}" 
                             data-comment-id="{{ comment.id }}">
                            <div class="comment-header">
                                <div class="comment-author">
                                    <div class="comment-avatar">
                                        {{ comment.author.username|slice:":1"|upper }}
                                    </div>
                                    <div class="comment-info">
                                        <strong class="comment-name">{{ comment.author.username }}</strong>
                                        {% if comment.author == post.author %}
                                        <span class="comment-badge author">üëë T√°c gi·∫£</span>
                                        {% endif %}
                                        <span class="comment-time">{{ comment.created_at|timesince }} tr∆∞·ªõc</span>
                                    </div>
                                </div>
                                
                                {% if user == comment.author or user.is_staff %}
                                <div class="comment-actions">
                                    <button class="action-btn edit-comment" title="Ch·ªânh s·ª≠a">‚úèÔ∏è</button>
                                    <button class="action-btn delete-comment" title="Xo√°">üóëÔ∏è</button>
                                    {% if user.is_staff %}
                                    <button class="action-btn report-comment" title="B√°o c√°o">üö®</button>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="comment-content">
                                {{ comment.content|linebreaksbr }}
                            </div>
                            
                            <div class="comment-footer">
                                <button class="reply-btn" onclick="replyToComment({{ comment.id }}, '{{ comment.author.username }}')">
                                    <span>‚Ü©Ô∏è</span>
                                    <span>Tr·∫£ l·ªùi</span>
                                </button>
                                
                                <button class="like-comment {% if comment.user_has_liked %}active{% endif %}">
                                    <span>üëç</span>
                                    <span>{{ comment.like_count|default:"0" }}</span>
                                </button>
                            </div>
                            
                            <!-- Reply Form (hidden by default) -->
                            <div class="reply-form" style="display: none;" id="replyForm{{ comment.id }}">
                                <textarea placeholder="Tr·∫£ l·ªùi {{ comment.author.username }}..." rows="2"></textarea>
                                <div class="reply-actions">
                                    <button class="btn-cancel" onclick="cancelReply({{ comment.id }})">H·ªßy</button>
                                    <button class="btn-send" onclick="sendReply({{ comment.id }})">G·ª≠i</button>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="no-comments">
                            <div class="no-comments-icon">üí¨</div>
                            <h3>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o</h3>
                            <p>H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n b√¨nh lu·∫≠n cho b√†i vi·∫øt n√†y!</p>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Load More -->
                    {% if comments.has_next %}
                    <div class="load-more">
                        <button class="btn-load-more" onclick="loadMoreComments()">
                            <span>‚¨áÔ∏è</span>
                            <span>T·∫£i th√™m b√¨nh lu·∫≠n</span>
                        </button>
                    </div>
                    {% endif %}
                </section>
            </div>

            <!-- Right: Sidebar -->
            <div class="detail-sidebar">
                <!-- Author Info -->
                <div class="sidebar-section author-widget">
                    <h3 class="section-title">üë§ T√°c gi·∫£</h3>
                    <div class="author-profile">
                        <div class="profile-avatar large">
                            {{ post.author.username|slice:":1"|upper }}
                        </div>
                        <div class="profile-info">
                            <h4 class="profile-name">{{ post.author.username }}</h4>
                            <div class="profile-stats">
                                <div class="profile-stat">
                                    <span class="stat-number">{{ author_posts_count|default:"0" }}</span>
                                    <span class="stat-label">b√†i vi·∫øt</span>
                                </div>
                                <div class="profile-stat">
                                    <span class="stat-number">{{ author_comments_count|default:"0" }}</span>
                                    <span class="stat-label">b√¨nh lu·∫≠n</span>
                                </div>
                            </div>
                            <a href="{% url 'user_profile' post.author.username %}" class="btn-profile">
                                üëÅÔ∏è Xem trang c√° nh√¢n
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Related Posts -->
                <div class="sidebar-section">
                    <h3 class="section-title">B√†i vi·∫øt li√™n quan</h3>
                    <div class="related-posts">
                        {% for related in related_posts %}
                        <a href="{% url 'forum_detail' related.id %}" class="related-post">
                            <h4 class="related-title">{{ related.title|truncatechars:60 }}</h4>
                            <div class="related-meta">
                                <span class="related-comments">üí¨ {{ related.comment_count }}</span>
                                <span class="related-time">{{ related.created_at|timesince }} tr∆∞·ªõc</span>
                            </div>
                        </a>
                        {% empty %}
                        <div class="no-related">
                            <p>Ch∆∞a c√≥ b√†i vi·∫øt li√™n quan</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Popular Tags -->
                <div class="sidebar-section">
                    <h3 align="center" class="section-title">Th·∫ª ph·ªï bi·∫øn</h3>
                    <div class="popular-tags">
                        <a href="{% url 'forum_tag' 'python' %}" class="popular-tag">python</a>
                        <a href="{% url 'forum_tag' 'django' %}" class="popular-tag">django</a>
                        <a href="{% url 'forum_tag' 'javascript' %}" class="popular-tag">javascript</a>
                        <a href="{% url 'forum_tag' 'web-development' %}" class="popular-tag">web-development</a>
                        <a href="{% url 'forum_tag' 'react' %}" class="popular-tag">react</a>
                        <a href="{% url 'forum_tag' 'database' %}" class="popular-tag">database</a>
                    </div>
                </div>

                <!-- Community Stats -->
                <div class="sidebar-section">
                    <h3 class="section-title">Th·ªëng k√™ c·ªông ƒë·ªìng</h3>
                    <div class="community-stats">
                        <div class="community-stat">
                            <span class="stat-icon">üìù</span>
                            <div class="stat-info">
                                <span class="stat-number">{{ total_posts|default:"1.2k" }}</span>
                                <span class="stat-label">b√†i vi·∫øt</span>
                            </div>
                        </div>
                        <div class="community-stat">
                            <span class="stat-icon">üí¨</span>
                            <div class="stat-info">
                                <span class="stat-number">{{ total_comments|default:"5.8k" }}</span>
                                <span class="stat-label">b√¨nh lu·∫≠n</span>
                            </div>
                        </div>
                        <div class="community-stat">
                            <span class="stat-icon">üë•</span>
                            <div class="stat-info">
                                <span class="stat-number">{{ total_users|default:"850" }}</span>
                                <span class="stat-label">th√†nh vi√™n</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="sidebar-section">
                    <h3 class="section-title">H√†nh ƒë·ªông nhanh</h3>
                    <div class="quick-actions">
                        <button class="quick-action" onclick="scrollToComments()">
                            <span class="action-icon">üí¨</span>
                            <span class="action-text">Vi·∫øt b√¨nh lu·∫≠n</span>
                        </button>
                        <button class="quick-action" onclick="sharePost()">
                            <span class="action-icon">üì§</span>
                            <span class="action-text">Chia s·∫ª b√†i vi·∫øt</span>
                        </button>
                        <a href="{% url 'forum_create' %}" class="quick-action">
                            <span class="action-icon">üìù</span>
                            <span class="action-text">Vi·∫øt b√†i m·ªõi</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Delete Confirmation -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <h3>üóëÔ∏è X√°c nh·∫≠n xo√°</h3>
        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° b√†i vi·∫øt n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal()">H·ªßy</button>
            <form method="post" action="{% url 'forum_delete' post.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn-delete">Xo√° b√†i vi·∫øt</button>
            </form>
        </div>
    </div>
</div>

<style>
/* ===== CSS ƒê·∫¶Y ƒê·ª¶ CHO FORUM DETAIL ===== */
:root {
    --accent: #3b82f6;
    --accent-2: #6366f1;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --text: #1e293b;
    --muted: #64748b;
    --light: #f8fafc;
    --border: #e2e8f0;
    --shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    --radius: 12px;
    --transition: all 0.3s ease;
}

/* Reset & Base */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    color: var(--text);
    line-height: 1.6;
    background: #f5f7fa;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}

/* ===== BREADCRUMB ===== */
.breadcrumb-optimized {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 1rem 0;
    border-bottom: 1px solid rgba(226, 232, 240, 0.8);
    transition: var(--transition);
}

.breadcrumb-optimized.sticky {
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    padding: 0.75rem 0;
    background: rgba(255, 255, 255, 0.98);
}

.cart-breadcrumb {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    flex-wrap: wrap;
}

.crumb {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
    padding: 6px 10px;
    border-radius: 8px;
    transition: var(--transition);
    white-space: nowrap;
}

.crumb:hover {
    background: rgba(59, 130, 246, 0.1);
    transform: translateY(-1px);
}

.crumb.current {
    color: var(--text);
    font-weight: 600;
    background: #f8fafc;
    cursor: default;
}

.crumb.current:hover {
    background: #f8fafc;
    transform: none;
}

.crumb-separator {
    color: var(--muted);
    font-size: 0.8em;
}

/* ===== NAVIGATION ===== */
.detail-navigation {
    background: white;
    border-bottom: 1px solid var(--border);
    margin: 1rem 0 2rem;
    padding: 1rem 0;
}

.nav-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.nav-back {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
    padding: 8px 16px;
    border-radius: 8px;
    transition: var(--transition);
}

.nav-back:hover {
    background: rgba(59, 130, 246, 0.1);
}

.nav-icon {
    font-size: 1.2em;
}

.nav-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

.nav-action, .dropdown-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text);
    transition: var(--transition);
}

.nav-action:hover, .dropdown-toggle:hover {
    background: #f8fafc;
    border-color: var(--accent);
}

/* Dropdown */
.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-menu {
    display: none;
    position: absolute;
    right: 0;
    top: 100%;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    min-width: 200px;
    box-shadow: var(--shadow);
    z-index: 100;
    margin-top: 5px;
    overflow: hidden;
}

.dropdown:hover .dropdown-menu {
    display: block;
}

.dropdown-item, .dropdown-form button {
    display: block;
    width: 100%;
    padding: 12px 16px;
    border: none;
    background: none;
    text-align: left;
    cursor: pointer;
    color: var(--text);
    font-size: 0.9rem;
    transition: var(--transition);
    text-decoration: none;
}

.dropdown-item:hover, .dropdown-form button:hover {
    background: #f8fafc;
}

.dropdown-form {
    margin: 0;
}

/* ===== MAIN LAYOUT ===== */
.detail-wrapper {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 30px;
    margin: 2rem 0;
}

@media (max-width: 1024px) {
    .detail-wrapper {
        grid-template-columns: 1fr;
    }
}

/* ===== MAIN POST ===== */
.detail-main {
    background: white;
    border-radius: var(--radius);
    padding: 2rem;
    box-shadow: var(--shadow);
}

.post-badges {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
}

.badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.badge.pinned {
    background: #fef3c7;
    color: #92400e;
}

.badge.featured {
    background: #dbeafe;
    color: #1e40af;
}

.badge.solved {
    background: #d1fae5;
    color: #065f46;
}

.badge.category {
    background: #f3f4f6;
    color: var(--text);
}

/* Post Header */
.post-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 20px;
}

.author-section {
    display: flex;
    align-items: center;
    gap: 15px;
}

.author-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
}

.author-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.author-main {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.author-name {
    font-weight: 600;
    font-size: 1.1rem;
}

.author-badge {
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 500;
}

.author-badge.staff {
    background: #fee2e2;
    color: #991b1b;
}

.author-badge.expert {
    background: #dbeafe;
    color: #1e40af;
}

.post-meta {
    font-size: 0.85rem;
    color: var(--muted);
    display: flex;
    gap: 8px;
    align-items: center;
}

.post-stats {
    display: flex;
    gap: 20px;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.9rem;
    color: var(--muted);
}

.stat-icon {
    font-size: 1.1em;
}

/* Post Title */
.post-title {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1.3;
    margin-bottom: 1.5rem;
    color: var(--text);
}

/* Post Content */
.post-content {
    font-size: 1.05rem;
    line-height: 1.8;
    margin-bottom: 2rem;
    color: #374151;
}

.post-content p {
    margin-bottom: 1rem;
}

.post-content a {
    color: var(--accent);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: var(--transition);
}

.post-content a:hover {
    border-bottom-color: var(--accent);
}

/* Post Tags */
.post-tags {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--border);
}

.post-tag {
    padding: 6px 12px;
    background: #f3f4f6;
    border-radius: 20px;
    font-size: 0.85rem;
    color: var(--muted);
    text-decoration: none;
    transition: var(--transition);
}

.post-tag:hover {
    background: #e5e7eb;
    color: var(--text);
}

/* Post Footer */
.post-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
    flex-wrap: wrap;
    gap: 20px;
}

.reaction-section {
    display: flex;
    align-items: center;
    gap: 10px;
    position: relative;
}

.reaction-form {
    margin: 0;
}

.reaction-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text);
    transition: var(--transition);
    border: none;
}

.reaction-btn:hover {
    background: #f8fafc;
    border-color: var(--accent);
}

.reaction-btn.active {
    background: #fee2e2;
    color: #dc2626;
}

.reactions-panel {
    display: none;
    position: absolute;
    bottom: 100%;
    left: 0;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px;
    box-shadow: var(--shadow);
    z-index: 10;
    gap: 5px;
    flex-wrap: wrap;
    width: 200px;
}

.reactions-panel.show {
    display: flex;
}

.reaction-option {
    font-size: 1.5rem;
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    border-radius: 5px;
    transition: var(--transition);
}

.reaction-option:hover {
    background: #f3f4f6;
    transform: scale(1.2);
}

.action-section {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text);
    transition: var(--transition);
    border: none;
}

.action-btn:hover {
    background: #f8fafc;
    border-color: var(--accent);
}

.action-btn.active {
    background: #dbeafe;
    color: var(--accent);
    border-color: var(--accent);
}

/* Post Navigation */
.post-navigation {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border);
}

@media (max-width: 768px) {
    .post-navigation {
        grid-template-columns: 1fr;
    }
}

.nav-post {
    padding: 1rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    text-decoration: none;
    color: var(--text);
    transition: var(--transition);
}

.nav-post:hover {
    border-color: var(--accent);
    background: #f8fafc;
    transform: translateY(-2px);
}

.nav-direction {
    display: block;
    font-size: 0.85rem;
    color: var(--muted);
    margin-bottom: 5px;
}

.nav-title {
    font-weight: 500;
    display: block;
}

.nav-post.prev {
    text-align: left;
}

.nav-post.next {
    text-align: right;
}

/* ===== COMMENTS SECTION ===== */
.comments-section {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 15px;
}

.section-header h2 {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.5rem;
}

.comment-count {
    color: var(--muted);
    font-weight: normal;
    font-size: 1rem;
}

.sort-btn {
    padding: 8px 16px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Comment Form */
.comment-form {
    margin-bottom: 2rem;
}

.comment-editor {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
}

.editor-header {
    background: #f8fafc;
    padding: 10px 15px;
    border-bottom: 1px solid var(--border);
}

.editor-tools {
    display: flex;
    gap: 10px;
}

.tool-btn {
    padding: 5px 10px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    font-family: monospace;
    font-size: 0.9rem;
}

.tool-btn:hover {
    background: #f3f4f6;
}

.comment-input {
    width: 100%;
    padding: 15px;
    border: none;
    font-family: inherit;
    font-size: 1rem;
    resize: vertical;
    min-height: 100px;
}

.comment-input:focus {
    outline: none;
}

.editor-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    background: #f8fafc;
    border-top: 1px solid var(--border);
    font-size: 0.85rem;
    color: var(--muted);
}

.btn-submit {
    padding: 8px 20px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: var(--transition);
}

.btn-submit:hover {
    background: #2563eb;
    transform: translateY(-1px);
}

/* Auth Prompt */
.auth-prompt {
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: var(--radius);
    padding: 2rem;
    text-align: center;
    margin-bottom: 2rem;
}

.prompt-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
}

.prompt-content h3 {
    margin-bottom: 0.5rem;
    color: var(--text);
}

.prompt-content p {
    color: var(--muted);
    margin-bottom: 1.5rem;
}

.prompt-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
}

.btn-login, .btn-signup {
    padding: 10px 20px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    transition: var(--transition);
}

.btn-login {
    background: var(--accent);
    color: white;
}

.btn-login:hover {
    background: #2563eb;
}

.btn-signup {
    background: white;
    color: var(--accent);
    border: 1px solid var(--accent);
}

.btn-signup:hover {
    background: #f8fafc;
}

/* Comments List */
.comments-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.comment-card {
    background: white;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.5rem;
    transition: var(--transition);
}

.comment-card:hover {
    border-color: var(--accent);
    box-shadow: var(--shadow);
}

.comment-card.author-comment {
    border-left: 4px solid var(--accent);
    background: #f8fafc;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.comment-author {
    display: flex;
    align-items: center;
    gap: 10px;
}

.comment-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
}

.comment-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.comment-name {
    font-weight: 600;
    font-size: 0.95rem;
}

.comment-badge {
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 10px;
    background: #fee2e2;
    color: #991b1b;
}

.comment-time {
    font-size: 0.8rem;
    color: var(--muted);
}

.comment-actions {
    display: flex;
    gap: 5px;
}

.comment-actions .action-btn {
    padding: 5px;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 0.9rem;
    opacity: 0.7;
}

.comment-actions .action-btn:hover {
    opacity: 1;
    background: #f3f4f6;
    border-radius: 4px;
}

.comment-content {
    margin-bottom: 1rem;
    line-height: 1.6;
}

.comment-footer {
    display: flex;
    gap: 15px;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
}

.reply-btn, .like-comment {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.85rem;
    color: var(--muted);
    transition: var(--transition);
}

.reply-btn:hover, .like-comment:hover {
    color: var(--text);
    background: #f3f4f6;
    border-radius: 4px;
}

.like-comment.active {
    color: var(--accent);
}

/* Reply Form */
.reply-form {
    margin-top: 1rem;
    padding: 1rem;
    background: #f8fafc;
    border-radius: var(--radius);
}

.reply-form textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    resize: vertical;
    font-family: inherit;
    margin-bottom: 10px;
}

.reply-form textarea:focus {
    outline: none;
    border-color: var(--accent);
}

.reply-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.btn-cancel, .btn-send {
    padding: 6px 16px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 500;
}

.btn-cancel {
    background: #f3f4f6;
    color: var(--text);
}

.btn-cancel:hover {
    background: #e5e7eb;
}

.btn-send {
    background: var(--accent);
    color: white;
}

.btn-send:hover {
    background: #2563eb;
}

/* No Comments */
.no-comments {
    text-align: center;
    padding: 3rem;
    color: var(--muted);
}

.no-comments-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.no-comments h3 {
    margin-bottom: 0.5rem;
    color: var(--text);
}

/* Load More */
.load-more {
    text-align: center;
    margin-top: 2rem;
}

.btn-load-more {
    padding: 12px 30px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    color: var(--text);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: var(--transition);
}

.btn-load-more:hover {
    border-color: var(--accent);
    background: #f8fafc;
    transform: translateY(-2px);
}

/* ===== SIDEBAR ===== */
.detail-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.sidebar-section {
    background: white;
    border-radius: var(--radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
}

.section-title {
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border);
    text-align: center;
    display: block;
    max-width: 720px;
    margin-left: auto;
    margin-right: auto;
}

/* Author Widget */
.author-profile {
    text-align: center;
}

.profile-avatar.large {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
    margin: 0 auto 1rem;
}

.profile-name {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 1rem;
}

.profile-stats {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 1rem;
}

.profile-stat {
    text-align: center;
}

.stat-number {
    display: block;
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--accent);
}

.stat-label {
    font-size: 0.85rem;
    color: var(--muted);
}

.btn-profile {
    display: inline-block;
    padding: 8px 16px;
    background: var(--accent);
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-size: 0.9rem;
    transition: var(--transition);
}

.btn-profile:hover {
    background: #2563eb;
    transform: translateY(-1px);
}

/* Related Posts */
.related-posts {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.related-post {
    padding: 1rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    text-decoration: none;
    color: var(--text);
    transition: var(--transition);
}

.related-post:hover {
    border-color: var(--accent);
    background: #f8fafc;
    transform: translateX(5px);
}

.related-title {
    font-size: 0.95rem;
    font-weight: 500;
    margin-bottom: 5px;
    line-height: 1.4;
}

.related-meta {
    display: flex;
    gap: 15px;
    font-size: 0.8rem;
    color: var(--muted);
}

/* Popular Tags */
.popular-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.popular-tag {
    padding: 6px 12px;
    background: #f3f4f6;
    border-radius: 20px;
    font-size: 0.85rem;
    color: var(--muted);
    text-decoration: none;
    transition: var(--transition);
}

.popular-tag:hover {
    background: #e5e7eb;
    color: var(--text);
}

/* Community Stats */
.community-stats {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.community-stat {
    display: flex;
    align-items: center;
    gap: 12px;
}

.stat-icon {
    font-size: 1.2rem;
    width: 40px;
    height: 40px;
    background: #f3f4f6;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.stat-info {
    display: flex;
    flex-direction: column;
}

.stat-number {
    font-weight: 600;
    font-size: 1.1rem;
}

.stat-label {
    font-size: 0.85rem;
    color: var(--muted);
}

/* Quick Actions */
.quick-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.quick-action {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    text-decoration: none;
    color: var(--text);
    cursor: pointer;
    transition: var(--transition);
    border: none;
    text-align: left;
    font-size: 0.95rem;
}

.quick-action:hover {
    border-color: var(--accent);
    background: #f8fafc;
    transform: translateX(5px);
}

.action-icon {
    font-size: 1.1rem;
}

/* ===== MODAL ===== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.show {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: var(--radius);
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
}

.modal-content h3 {
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.modal-content p {
    color: var(--muted);
    margin-bottom: 1.5rem;
}

.modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.btn-cancel, .btn-delete {
    padding: 10px 20px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 500;
}

.btn-cancel {
    background: #f3f4f6;
    color: var(--text);
}

.btn-cancel:hover {
    background: #e5e7eb;
}

.btn-delete {
    background: var(--danger);
    color: white;
}

.btn-delete:hover {
    background: #dc2626;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .post-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .post-stats {
        width: 100%;
        justify-content: space-between;
    }
    
    .post-title {
        font-size: 1.5rem;
    }
    
    .post-footer {
        flex-direction: column;
        align-items: stretch;
    }
    
    .action-section {
        justify-content: center;
    }
    
    .nav-content {
        flex-direction: column;
        gap: 15px;
    }
    
    .cart-breadcrumb .crumb span:last-child:not(.current) {
        display: none;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 0 15px;
    }
    
    .detail-main, .sidebar-section {
        padding: 1.25rem;
    }
    
    .author-section {
        flex-direction: column;
        text-align: center;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Khi trang ƒë∆∞·ª£c m·ªü, t·ª± ƒë·ªông cu·ªôn ƒë·ªÉ breadcrumb n·∫±m ·ªü ƒë·∫ßu trang
    (function autoScrollToBreadcrumb(){
        const bc = document.getElementById('breadcrumb');
        if (!bc) return;
        // T√≠nh v·ªã tr√≠ tuy·ªát ƒë·ªëi c·ªßa breadcrumb v√† cu·ªôn t·ªõi ƒë√≥ ngay l·∫≠p t·ª©c
        const y = bc.getBoundingClientRect().top + window.pageYOffset;
        window.scrollTo({ top: y, behavior: 'auto' });
    })();
    // Breadcrumb sticky effect
    const breadcrumb = document.getElementById('breadcrumb');
    if (breadcrumb) {
        window.addEventListener('scroll', function() {
            if (window.scrollY > 50) {
                breadcrumb.classList.add('sticky');
            } else {
                breadcrumb.classList.remove('sticky');
            }
        });
        
        // Responsive breadcrumb
        function handleResponsiveBreadcrumb() {
            const crumbs = breadcrumb.querySelectorAll('.crumb span:last-child');
            const isMobile = window.innerWidth <= 768;
            
            crumbs.forEach(crumb => {
                if (isMobile && !crumb.closest('.crumb').classList.contains('current')) {
                    crumb.style.display = 'none';
                } else {
                    crumb.style.display = 'inline';
                }
            });
        }
        
        handleResponsiveBreadcrumb();
        window.addEventListener('resize', handleResponsiveBreadcrumb);
    }

    // C√°c JavaScript kh√°c gi·ªØ nguy√™n...
    // Elements
    const likeForm = document.querySelector('.like-form');
    const likeBtn = document.querySelector('.like-btn');
    const reactionsPanel = document.getElementById('reactionsPanel');
    const commentForm = document.getElementById('commentForm');
    const commentInput = document.querySelector('.comment-input');
    const deleteModal = document.getElementById('deleteModal');
    const toolButtons = document.querySelectorAll('.tool-btn');
    const deletePostBtn = document.querySelector('.delete-post');
    
    // Like functionality
    if (likeBtn) {
        likeBtn.addEventListener('click', function(e) {
            if (likeForm) {
                const formData = new FormData(likeForm);
                
                fetch(likeForm.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.classList.toggle('active');
                        const countSpan = this.querySelector('.reaction-count');
                        countSpan.textContent = data.like_count;
                        
                        if (this.classList.contains('active')) {
                            this.querySelector('.reaction-icon').textContent = '‚ù§Ô∏è';
                            this.querySelector('.reaction-label').textContent = 'ƒê√£ th√≠ch';
                        } else {
                            this.querySelector('.reaction-icon').textContent = 'ü§ç';
                            this.querySelector('.reaction-label').textContent = 'Th√≠ch';
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });
    }
    
    // Toggle reactions panel
    function toggleReactions() {
        reactionsPanel.classList.toggle('show');
    }
    
    // Close reactions panel when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.reaction-section')) {
            reactionsPanel.classList.remove('show');
        }
    });
    
    // Reaction buttons
    document.querySelectorAll('.reaction-option').forEach(btn => {
        btn.addEventListener('click', function() {
            const reaction = this.dataset.reaction;
            console.log(`Selected reaction: ${reaction}`);
            reactionsPanel.classList.remove('show');
            // Here you would send the reaction to server
        });
    });
    
    // Share post
    window.sharePost = function() {
        const shareData = {
            title: '{{ post.title }}',
            text: '{{ post.content|truncatewords:30 }}',
            url: window.location.href
        };
        
        if (navigator.share) {
            navigator.share(shareData)
                .then(() => console.log('B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c chia s·∫ª'))
                .catch(error => console.log('L·ªói chia s·∫ª:', error));
        } else {
            // Fallback: Copy to clipboard
            navigator.clipboard.writeText(window.location.href)
                .then(() => alert('üìã ƒê√£ sao ch√©p link b√†i vi·∫øt v√†o clipboard!'))
                .catch(err => console.error('L·ªói sao ch√©p:', err));
        }
    };
    
    // Toggle bookmark
    window.toggleBookmark = function() {
        const bookmarkBtn = document.querySelector('.bookmark-btn');
        bookmarkBtn.classList.toggle('active');
        
        if (bookmarkBtn.classList.contains('active')) {
            bookmarkBtn.querySelector('.action-icon').textContent = 'üîñ';
            bookmarkBtn.querySelector('.action-text').textContent = 'ƒê√£ l∆∞u';
            console.log('B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c l∆∞u');
        } else {
            bookmarkBtn.querySelector('.action-icon').textContent = 'üîñ';
            bookmarkBtn.querySelector('.action-text').textContent = 'L∆∞u';
            console.log('B√†i vi·∫øt ƒë√£ b·ªè l∆∞u');
        }
    };
    
    // Report post
    window.reportPost = function() {
        const reason = prompt('Vui l√≤ng nh·∫≠p l√Ω do b√°o c√°o b√†i vi·∫øt:');
        if (reason) {
            console.log('Report submitted:', reason);
            alert('C·∫£m ∆°n b·∫°n ƒë√£ b√°o c√°o. Ch√∫ng t√¥i s·∫Ω xem x√©t b√†i vi·∫øt n√†y.');
        }
    };
    
    // Scroll to comments
    window.scrollToComments = function() {
        document.getElementById('commentsSection').scrollIntoView({
            behavior: 'smooth'
        });
        if (commentInput) commentInput.focus();
    };
    
    // Toggle sort comments
    window.toggleSort = function() {
        const sortText = document.getElementById('sortText');
        const currentSort = sortText.textContent;
        const options = ['M·ªõi nh·∫•t', 'C≈© nh·∫•t', 'Nhi·ªÅu like nh·∫•t'];
        const currentIndex = options.indexOf(currentSort);
        const nextIndex = (currentIndex + 1) % options.length;
        sortText.textContent = options[nextIndex];
        console.log('Sorting by:', options[nextIndex]);
    };
    
    // Editor tools for comments
    toolButtons.forEach(button => {
        button.addEventListener('click', function() {
            if (!commentInput) return;
            
            const tag = this.dataset.tag;
            const start = commentInput.selectionStart;
            const end = commentInput.selectionEnd;
            const selectedText = commentInput.value.substring(start, end);
            let newText = '';
            
            switch(tag) {
                case 'bold':
                    newText = `**${selectedText || 'vƒÉn b·∫£n'}**`;
                    break;
                case 'italic':
                    newText = `*${selectedText || 'vƒÉn b·∫£n'}*`;
                    break;
                case 'code':
                    newText = selectedText ? `\`${selectedText}\`` : '`code`';
                    break;
                case 'link':
                    newText = `[${selectedText || 'vƒÉn b·∫£n'}](https://example.com)`;
                    break;
            }
            
            commentInput.setRangeText(newText, start, end, 'end');
            commentInput.focus();
        });
    });
    
    // Submit comment on Ctrl+Enter
    if (commentInput) {
        commentInput.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter' && commentForm) {
                e.preventDefault();
                commentForm.submit();
            }
        });
    }

    // Helper: get CSRF cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Small notification helper (top-right)
    function showNotification(message, type = 'success') {
        const old = document.querySelector('.forum-notification');
        if (old) old.remove();
        const n = document.createElement('div');
        n.className = 'forum-notification ' + type;
        n.innerHTML = `<div class="notif-content">${type === 'error' ? '‚ùå' : '‚úÖ'} ${message}</div>`;
        Object.assign(n.style, {
            position: 'fixed',
            top: '20px',
            right: '20px',
            zIndex: 99999,
            background: type === 'error' ? '#fee2e2' : '#ecfdf5',
            color: '#0f172a',
            padding: '12px 16px',
            borderRadius: '8px',
            boxShadow: '0 6px 20px rgba(0,0,0,0.08)'
        });
        document.body.appendChild(n);
        setTimeout(() => {
            n.remove();
        }, 3000);
    }

    // AJAX submit for comment form
    if (commentForm) {
        commentForm.addEventListener('submit', async function(e) {
            // If browser triggered a direct navigation (no JS), let it proceed
            e.preventDefault();
            const formData = new FormData(commentForm);
            try {
                const resp = await fetch(commentForm.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                });

                const data = await resp.json();
                if (data && data.success) {
                    // Build comment node
                    const list = document.getElementById('commentsList');
                    const node = document.createElement('div');
                    node.className = 'comment-card';
                    node.innerHTML = `
                        <div class="comment-header">
                            <div class="comment-author">
                                <div class="comment-avatar">${data.comment.avatar}</div>
                                <div class="comment-info">
                                    <strong class="comment-name">${data.comment.author}</strong>
                                    <span class="comment-time">${data.comment.created_at} tr∆∞·ªõc</span>
                                </div>
                            </div>
                        </div>
                        <div class="comment-content">${data.comment.content}</div>
                        <div class="comment-footer">
                            <button class="reply-btn">‚Ü©Ô∏è Tr·∫£ l·ªùi</button>
                            <button class="like-comment">üëç 0</button>
                        </div>
                    `;
                    // Prepend new comment
                    if (list) list.prepend(node);
                    // Clear form
                    commentForm.reset();
                    // Update comment count display if present
                    const countEl = document.querySelector('.comment-count');
                    if (countEl) {
                        // Extract number from text like '(12)'
                        const m = countEl.textContent.match(/\d+/);
                        const cur = m ? parseInt(m[0], 10) : 0;
                        countEl.textContent = `(${cur + 1})`;
                    }
                    showNotification('G·ª≠i b√¨nh lu·∫≠n th√†nh c√¥ng', 'success');
                } else {
                    showNotification((data && data.error) ? data.error : 'Kh√¥ng th·ªÉ g·ª≠i b√¨nh lu·∫≠n', 'error');
                }
            } catch (err) {
                console.error(err);
                showNotification('L·ªói m·∫°ng, vui l√≤ng th·ª≠ l·∫°i', 'error');
            }
        });
    }
    
    // Reply to comment
    window.replyToComment = function(commentId, username) {
        const replyForm = document.getElementById(`replyForm${commentId}`);
        const textarea = replyForm.querySelector('textarea');
        
        // Hide other reply forms
        document.querySelectorAll('.reply-form').forEach(form => {
            form.style.display = 'none';
        });
        
        // Show this reply form
        replyForm.style.display = 'block';
        textarea.placeholder = `Tr·∫£ l·ªùi ${username}...`;
        textarea.focus();
    };
    
    window.cancelReply = function(commentId) {
        const replyForm = document.getElementById(`replyForm${commentId}`);
        replyForm.style.display = 'none';
    };
    
    window.sendReply = function(commentId) {
        const replyForm = document.getElementById(`replyForm${commentId}`);
        const textarea = replyForm.querySelector('textarea');
        const content = textarea.value.trim();
        
        if (content) {
            console.log('Sending reply to comment', commentId, ':', content);
            // Here you would send the reply to server
            replyForm.style.display = 'none';
            textarea.value = '';
        } else {
            alert('Vui l√≤ng nh·∫≠p n·ªôi dung tr·∫£ l·ªùi!');
        }
    };
    
    // Load more comments
    window.loadMoreComments = function() {
        console.log('Loading more comments...');
        // Here you would fetch more comments via AJAX
    };
    
    // Delete post modal
    if (deletePostBtn) {
        deletePostBtn.addEventListener('click', function() {
            deleteModal.classList.add('show');
        });
    }
    
    window.closeModal = function() {
        deleteModal.classList.remove('show');
    };
    
    // Close modal when clicking outside
    deleteModal.addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    // Initialize
    console.log('Forum detail page loaded');
});
</script>
{% endblock %}